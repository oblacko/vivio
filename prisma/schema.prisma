// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum VideoQuality {
  SD
  HD
  UPSCALED
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ChallengeCategory {
  MONUMENTS
  PETS
  FACES
  SEASONAL
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  image         String?
  socialLinks   Json?     // { twitter?: string, instagram?: string, etc }
  isPublic      Boolean   @default(true)
  balance       Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  videos        Video[]
  generationJobs GenerationJob[]

  @@map("users")
}

model Challenge {
  id              String    @id @default(cuid())
  title           String
  description     String?
  category        ChallengeCategory
  thumbnailUrl    String?
  promptTemplate  String    // Шаблон промпта для этой категории
  participantCount Int      @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  videos          Video[]
  generationJobs  GenerationJob[]

  @@unique([title])
  @@map("challenges")
}

model GenerationJob {
  id              String    @id @default(cuid())
  userId          String?
  challengeId     String?
  externalJobId   String?   // ID задачи в Grok API (taskId)
  imageUrl        String
  prompt          String
  status          JobStatus @default(QUEUED)
  progress        Int       @default(0) // 0-100
  duration        Int       @default(6) // Фиксированная длительность 6 секунд
  errorMessage    String?
  estimatedTime   Int?      // Оценка времени в секундах
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  challenge       Challenge? @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  video           Video?

  @@index([userId])
  @@index([challengeId])
  @@index([status])
  @@index([externalJobId])
  @@map("generation_jobs")
}

model Video {
  id              String      @id @default(cuid())
  jobId           String      @unique
  userId          String?
  challengeId     String
  videoUrl        String      // URL в Vercel Blob Storage
  thumbnailUrl    String?
  duration        Int         @default(6) // 6 секунд
  quality         VideoQuality @default(HD)
  likesCount      Int         @default(0)
  viewsCount      Int         @default(0)
  isPublic        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  challenge       Challenge   @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  job             GenerationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([challengeId])
  @@index([createdAt])
  @@map("videos")
}
