# Тестирование коротких ссылок и метатегов

## Обзор

После реализации системы коротких ссылок `/v/[id]`, необходимо протестировать:
1. Корректность метатегов Open Graph
2. Работу редиректов для пользователей
3. Доступность метатегов для ботов соцсетей

## Автоматическое тестирование

### Использование test-short-url.js

Запустите скрипт для быстрой проверки:

```bash
# Локальное тестирование (требуется запущенный dev сервер)
node test-short-url.js http://localhost:3000/v/VIDEO_ID

# Тестирование на продакшене
node test-short-url.js https://vivio.vercel.app/v/VIDEO_ID
```

Скрипт проверит:
- ✅ Наличие всех обязательных метатегов
- ✅ Корректность размеров изображений
- ✅ Работу редиректа для браузеров
- ✅ Доступность метатегов для ботов

## Ручное тестирование

### 1. Facebook Sharing Debugger

**URL:** https://developers.facebook.com/tools/debug/

**Шаги:**
1. Вставьте короткую ссылку: `https://your-domain.com/v/VIDEO_ID`
2. Нажмите "Debug"
3. Проверьте что отображается:
   - ✅ Превью изображение (og:image)
   - ✅ Заголовок видео (og:title)
   - ✅ Описание (og:description)
   - ✅ Информация о видео (og:video)

**Что проверять:**
- Размеры изображения: минимум 1200x630px
- Изображение загружается без ошибок
- Все метатеги присутствуют
- URL корректный

**Если превью не обновляется:**
- Нажмите "Scrape Again" для обновления кэша

### 2. Twitter Card Validator

**URL:** https://cards-dev.twitter.com/validator

**Шаги:**
1. Вставьте короткую ссылку: `https://your-domain.com/v/VIDEO_ID`
2. Нажмите "Preview card"
3. Проверьте отображение карточки

**Что проверять:**
- Twitter Card тип: `player`
- Превью изображение отображается
- Заголовок и описание корректны
- Player URL указан

### 3. Telegram

**Шаги:**
1. Откройте любой чат в Telegram
2. Вставьте короткую ссылку: `https://your-domain.com/v/VIDEO_ID`
3. Отправьте сообщение

**Что проверять:**
- ✅ Превью автоматически загружается
- ✅ Отображается заголовок видео
- ✅ При клике открывается ссылка
- ✅ Редирект на полную страницу работает

**Для тестирования как бот:**
```bash
curl -H "User-Agent: TelegramBot (like TwitterBot)" \
  https://your-domain.com/v/VIDEO_ID | \
  grep -E "og:|twitter:"
```

### 4. VKontakte

**Шаги:**
1. Создайте новый пост на стене
2. Вставьте короткую ссылку
3. Дождитесь загрузки превью

**Что проверять:**
- Превью изображение отображается
- Заголовок и описание видны
- При клике открывается страница видео

### 5. WhatsApp

**Шаги:**
1. Откройте любой чат
2. Вставьте короткую ссылку
3. Отправьте сообщение

**Что проверять:**
- Превью автоматически загружается
- Заголовок отображается
- При клике открывается браузер

## Проверка редиректов

### Для ботов (должны видеть метатеги)

```bash
# Запрос как бот
curl -I -H "User-Agent: TelegramBot" https://your-domain.com/v/VIDEO_ID

# Проверяем что НЕТ HTTP редиректа (200 OK)
# Если есть 301/302 - боты не увидят метатеги!
```

### Для браузеров (должен работать редирект)

```bash
# Запрос как браузер
curl -L -I https://your-domain.com/v/VIDEO_ID

# Финальный URL должен быть /videos/VIDEO_ID
```

## Проверка через DevTools

### Chrome DevTools

1. Откройте `https://your-domain.com/v/VIDEO_ID`
2. Откройте DevTools (F12)
3. Перейдите во вкладку Network
4. Обновите страницу

**Что проверять:**
- Первый запрос возвращает 200 (не 301/302)
- HTML содержит метатеги в `<head>`
- Затем происходит client-side редирект

### View Page Source

1. Откройте `https://your-domain.com/v/VIDEO_ID`
2. Нажмите Ctrl+U (или View Page Source)
3. Проверьте наличие метатегов в `<head>`

**Должны присутствовать:**
```html
<meta property="og:title" content="...">
<meta property="og:description" content="...">
<meta property="og:image" content="...">
<meta property="og:video" content="...">
<meta property="og:type" content="video.other">
<meta name="twitter:card" content="player">
```

## Распространенные проблемы

### Проблема: Соцсеть не показывает превью

**Решения:**
1. Проверьте через Facebook Debugger
2. Очистите кэш соцсети (кнопка "Scrape Again")
3. Убедитесь что изображение доступно публично
4. Проверьте размеры изображения (минимум 1200x630)

### Проблема: Редирект не работает

**Решения:**
1. Проверьте что страница `/v/[id]/page.tsx` создана
2. Убедитесь что `redirect()` вызывается
3. Проверьте консоль браузера на ошибки
4. Убедитесь что видео существует в БД

### Проблема: Метатеги не читаются ботами

**Решения:**
1. Проверьте что нет HTTP 301/302 редиректа
2. Используйте `generateMetadata()` а не client-side метатеги
3. Убедитесь что Next.js генерирует статический HTML
4. Проверьте через curl с User-Agent бота

### Проблема: Изображение не загружается

**Решения:**
1. Проверьте `thumbnailUrl` в базе данных
2. Убедитесь что fallback `/api/og?id=VIDEO_ID` работает
3. Проверьте CORS настройки для изображений
4. Убедитесь что URL абсолютный (с протоколом)

## Метрики успеха

После тестирования все должны быть ✅:

- [ ] Facebook Debugger показывает превью
- [ ] Twitter Card отображается корректно
- [ ] Telegram показывает превью
- [ ] VK показывает превью
- [ ] Редирект работает в браузере
- [ ] Метатеги доступны ботам (без HTTP редиректа)
- [ ] Изображения загружаются (1200x630+)
- [ ] Видео URL корректный
- [ ] Canonical URL указывает на /videos/[id]

## Инструменты для тестирования

### Online инструменты

1. **Facebook Debugger:** https://developers.facebook.com/tools/debug/
2. **Twitter Card Validator:** https://cards-dev.twitter.com/validator
3. **LinkedIn Post Inspector:** https://www.linkedin.com/post-inspector/
4. **Open Graph Preview:** https://www.opengraph.xyz/

### CLI инструменты

```bash
# Проверка метатегов
curl -s https://your-domain.com/v/VIDEO_ID | grep -E "og:|twitter:"

# Проверка как бот
curl -H "User-Agent: TelegramBot" https://your-domain.com/v/VIDEO_ID

# Проверка редиректа
curl -I -L https://your-domain.com/v/VIDEO_ID

# Тест с Node.js скриптом
node test-short-url.js https://your-domain.com/v/VIDEO_ID
```

## Дальнейшие шаги

После успешного тестирования:

1. ✅ Обновите `SHARING_GUIDE.md` с новой информацией
2. ✅ Добавьте примеры в README.md
3. ✅ Обновите `.env.template` если нужно
4. ✅ Создайте PR с изменениями
5. ✅ Задеплойте на продакшен
6. ✅ Протестируйте на продакшене
7. ✅ Мониторьте аналитику шерингов

## FAQ

**Q: Почему используется client-side редирект вместо HTTP 301/302?**
A: HTTP редирект происходит до того как боты успевают прочитать метатеги. Client-side редирект через `redirect()` в Next.js позволяет серверу отрендерить HTML с метатегами, которые прочитают боты, и затем редиректить пользователей.

**Q: Будет ли это влиять на SEO?**
A: Нет, мы используем `canonical` URL указывающий на основную страницу `/videos/[id]`, что сообщает поисковикам правильный URL для индексации.

**Q: Можно ли использовать middleware для редиректа?**
A: Нет, middleware выполняет HTTP редирект до рендеринга, что не позволит ботам прочитать метатеги.

**Q: Как часто соцсети обновляют превью?**
A: Зависит от платформы. Facebook кэширует до 7 дней, Twitter - до 7 дней, Telegram - навсегда (пока не изменится URL).

---

**Создано:** 2026-01-19  
**Версия:** v1.0.0
